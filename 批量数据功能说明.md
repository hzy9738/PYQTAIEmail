# 批量数据邮件功能说明

## 版本更新

**版本**: 2.1.0
**更新日期**: 2025-10-17

## 新增功能:批量数据模式

### 功能概述

批量数据模式允许用户从一个文件夹中读取多个Excel文件,使用同一个Python脚本处理每个文件,并将生成的内容批量发送给多个收件人。

### 使用场景

- 需要向多个人发送多份数据报告
- 每份报告的格式相同,但数据来源不同
- 自动化数据报告生成和发送

### 功能特点

1. **多对多发送**: N个收件人 × M个Excel文件 = N×M封邮件
2. **统一脚本**: 使用同一个Python脚本处理所有Excel文件
3. **模板化主题**: 支持变量的邮件主题模板
4. **灵活配置**: 设置发送间隔避免被限流

## 使用步骤

### 1. 进入批量数据模式

1. 打开"寻拟邮件工具"
2. 切换到"发送邮件"标签页
3. 选择"批量数据"模式

### 2. 配置基本信息

**收件人**: 使用上方的"收件人"输入框,可以输入多个邮箱地址(用换行、逗号或分号分隔)

**主题模板**: 在批量数据标签页中输入邮件主题模板,支持以下变量:
- `{filename}` - 文件名(不含扩展名)
- `{filename_full}` - 文件名(含扩展名)
- `{index}` - 当前邮件序号(1, 2, 3...)
- `{total}` - 总邮件数
- `{date}` - 当前日期
- `{time}` - 当前时间

示例: `数据报告 - {filename} ({index}/{total})`

### 3. 选择Excel文件夹

1. 点击"浏览..."按钮选择包含Excel文件的文件夹
2. 点击"扫描"按钮,系统会自动列出所有Excel文件(.xlsx, .xls, .xlsm)

### 4. 编写Python脚本

#### 脚本可用变量

脚本执行时,系统会自动提供以下上下文变量:

```python
context = {
    'file': 'C:\\Data\\report1.xlsx',      # Excel文件完整路径
    'filename': 'report1',                  # 文件名(无扩展名)
    'filename_full': 'report1.xlsx',        # 文件名(含扩展名)
    'index': 1,                             # 当前是第几个文件
    'total': 5,                             # 总共��多少个文件
    'date': '2025-10-17',                   # 当前日期
    'time': '14:30:25',                     # 当前时间
    'datetime': '2025-10-17 14:30:25'       # 日期时间
}
```

#### 脚本模板示例

**模板1: 简单示例**

```python
import pandas as pd
from datetime import datetime

def generate_content():
    # 获取当前Excel文件信息
    file_path = context['file']
    filename = context['filename']
    index = context['index']
    total = context['total']

    # 读取Excel文件
    df = pd.read_excel(file_path)

    # 生成邮件内容
    content = f"尊敬的用户,您好!\n\n"
    content += f"这是第 {index}/{total} 份数据报告\n"
    content += f"文件名: {filename}\n\n"
    content += f"数据概览:\n"
    content += f"- 总行数: {len(df)}\n"
    content += f"- 总列数: {len(df.columns)}\n"
    content += f"- 列名: {', '.join(df.columns)}\n\n"
    content += df.head().to_string()
    content += f"\n\n发送时间: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"

    return content
```

**模板2: HTML表格**

```python
import pandas as pd
from datetime import datetime

def generate_content():
    file_path = context['file']
    filename = context['filename']
    index = context['index']
    total = context['total']

    df = pd.read_excel(file_path)

    html_content = f'''
    <html>
    <head>
        <style>
            body {{ font-family: Arial, sans-serif; }}
            h2 {{ color: #2c3e50; }}
            table {{ border-collapse: collapse; width: 100%; }}
            th {{ background-color: #3498db; color: white; padding: 10px; }}
            td {{ border: 1px solid #ddd; padding: 8px; }}
        </style>
    </head>
    <body>
        <h2>📊 {filename} 数据报告</h2>
        <p>这是第 <strong>{index}/{total}</strong> 份报告</p>

        <h3>详细数据</h3>
        {df.to_html(index=False)}

        <p>生成时间: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
    </body>
    </html>
    '''

    return html_content
```

### 5. 测试脚本

点击"测试脚本"按钮,系统会使用第一个Excel文件测试脚本,确保脚本可以正常执行。

### 6. 预览邮件

点击"预览第1封"按钮,可以预览第一封邮件的主题和内容。

### 7. 配置发送选项

- **HTML格式**: 勾选"使用HTML格式"后,邮件内容将以HTML格式发送(适合使用HTML表格的脚本)
- **发送间隔**: 设置每封邮件之间的间隔时间(秒),避免被邮件服务器限流

注意: 批量数据模式下不支持附件,附件区域会自动隐藏。

### 8. 发送邮件

1. 确认所有配置无误
2. 点击"立即发送"按钮
3. 系统会显示确认对话框,告知总邮件数(收件人数 × Excel文件数)
4. 确认后,系统会依次处理每个收件人的每个Excel文件,生成邮件内容并发送
5. 发送完成后会显示统计结果:成功X封,失败Y封

## 常见问题

### Q1: 脚本执行失败怎么办?

**A**:
1. 检查脚本语法是否正确
2. 确保Excel文件格式正确,列名匹配
3. 使用"测试脚本"功能调试

### Q2: 可以发送给多个收件人吗?

**A**: 可以

### Q3: Excel文件太大会影响发送吗?

**A**: 批量模式不支持附件

### Q4: 脚本中可以使用哪些Python库?

**A**:
- 已内置: pandas, numpy, openpyxl, datetime
- 其他库需要在本地Python环境中安装

### Q5: 发送失败会自动重试吗?

**A**: 不会自动重试。如果某个文件处理失败,系统会跳过并继续处理下一个文件。失败信息会在最终报告中显示。

## 技术说明

### 脚本执行机制

1. 系统扫描指定文件夹,找到所有Excel文件
2. 按文件名排序
3. 依次遍历每个Excel文件:
   - 准备上下文变量(文件路径、序号等)
   - 执行用户脚本,传入上下文
   - 获取脚本返回的邮件内容
   - 渲染主题模板
   - 发送邮件
   - 等待设定的间隔时间(如果不是最后一个)
4. 返回发送结果统计

### 安全性

- 脚本在沙箱环境中执行
- 不允许访问系统敏感信息
- 仅能读取指定的Excel文件

## 示例场景

### 场景1: 每日销售报告

每天需要向多个管理人员发送多个门店的销售数据:

1. 将所有门店的销售Excel文件放在一个文件夹
2. 编写脚本读取每个Excel的销售数据
3. 生成带有统计信息的HTML邮件
4. 一次性发送给所有管理人员(每人收到所有门店的报告)

### 场景2: 项目进度报告

需要向多个部门负责人发送多个项目的进度报告:

1. 每个项目一个Excel进度表
2. 脚本读取进度数据并生成格式化报告
3. 一次性发送给所有相关负责人

### 场景3: 财务报表

向多个财务人员发送多个项目的财务报表:

1. 每个项目一个Excel财务表
2. 脚本计算关键指标(收入、成本、利润率等)
3. 生成HTML格式的可视化报表
4. 批量发送给所有财务人员

## 版本历史

**v2.1.0** (2025-10-17)
- 新增批量数据邮件模式
- 支持Excel文件批量处理
- 新增4个批量数据脚本模板
- 支持主题模板变量
- 支持附件和发送间隔配置

**v2.0.0** (之前版本)
- 基础邮件发送功能
- Python脚本模式
- 定时任务
- 自动回复

## 技术支持

如有问题或建议,请联系开发团队。
